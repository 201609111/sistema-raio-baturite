<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S.G.P - Sistema de Gest√£o de Patrulha RAIO</title>
    <style>
        /* --- ESTILOS GERAIS --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #eef2f5; 
            margin: 0;
            padding: 15px; /* Margem menor para celular */
            font-size: 16px; 
            color: #333;
        }
        .container { 
            max-width: 800px; 
            margin: auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); 
            position: relative;
        }
        
        /* T√çTULOS */
        h2 { 
            color: #0056b3; 
            text-align: center; 
            margin-bottom: 25px; 
            font-size: 24px; 
            border-bottom: 2px solid #0056b3;
            padding-bottom: 10px;
        }
        
        /* GRID (LADO A LADO NO PC) */
        .form-row { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 15px; 
        }
        .form-group { flex: 1; }

        /* CAMPOS DE TEXTO */
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
            color: #2c3e50; 
            font-size: 16px; 
        }
        input, select {
            width: 100%; 
            padding: 12px; 
            border: 2px solid #bdc3c7; 
            border-radius: 8px; /* Bordas mais arredondadas (estilo app) */
            box-sizing: border-box;
            font-size: 16px; /* Tamanho bom para ler no celular */
            background-color: #fff;
            -webkit-appearance: none; /* Remove estilo padr√£o feio do iPhone */
        }
        input:focus, select:focus {
            border-color: #0056b3;
            outline: none;
            background-color: #f0f8ff;
        }
        
        /* C√ÇMERA */
        .camera-box {
            text-align: center;
            margin-bottom: 20px;
            background: #000;
            border-radius: 8px;
            padding: 10px;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        video { width: 100%; max-height: 350px; border-radius: 6px; display: none; background: #000; object-fit: cover; }
        canvas { display: none; }
        .preview-img { width: 100%; max-height: 350px; border-radius: 6px; display: none; border: 3px solid #28a745; margin-bottom: 10px; object-fit: contain; }
        .placeholder-text { color: #ccc; margin-bottom: 15px; }
        
        /* BOT√ïES */
        button { cursor: pointer; transition: filter 0.2s; }
        button:active { filter: brightness(0.9); transform: scale(0.98); }

        .btn-foto { background-color: #17a2b8; color: white; padding: 12px; border: none; border-radius: 8px; font-size: 18px; width: 100%; margin-top: 10px; }
        .btn-capturar { background-color: #ffc107; color: #000; font-weight: bold; }
        .btn-desativar { background-color: #dc3545; color: white; padding: 10px; border: none; border-radius: 8px; width: 100%; display: none; margin-top: 10px; font-size: 16px; }
        
        .btn-enviar { 
            background-color: #28a745; 
            color: white; 
            padding: 18px; 
            border: none; 
            border-radius: 8px; 
            width: 100%; 
            font-size: 20px; 
            font-weight: bold;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        .btn-novo { background-color: #007bff; color: white; padding: 15px; border: none; border-radius: 8px; width: 100%; font-size: 18px; margin-top: 20px; }
        
        /* BOT√ÉO ADMIN (PC) */
        .btn-admin {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #343a40;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            opacity: 0.8;
        }

        /* TABELA ADMIN */
        #adminArea { display: none; }
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; } /* Rolagem suave no iPhone */
        
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; min-width: 600px; /* Garante que a tabela n√£o esmague */ }
        .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .admin-table th { background-color: #0056b3; color: white; white-space: nowrap; }
        .admin-table tr:nth-child(even){background-color: #f8f9fa;}
        .admin-table img { width: 45px; height: 45px; border-radius: 5px; object-fit: cover; }

        #receiptArea { display: none; background-color: #f8f9fa; border: 2px dashed #28a745; padding: 20px; border-radius: 8px; }
        .receipt-item { display: flex; justify-content: space-between; border-bottom: 1px solid #e9ecef; padding: 12px 0; }
        .receipt-label { font-weight: bold; color: #555; }
        
        .message { margin-top: 25px; text-align: center; font-weight: bold; font-size: 18px; }

        /* --- ADAPTA√á√ÉO PARA CELULAR (MEDIA QUERIES) --- */
        @media (max-width: 768px) {
            .container {
                padding: 20px; /* Menos borda interna */
                width: 100%;   /* Usa toda a largura */
                box-shadow: none; /* Remove sombra pra parecer app nativo */
                border-radius: 0;
            }

            /* Bot√£o admin vira um bloco no topo no celular */
            .btn-admin {
                position: static;
                display: block;
                width: 100%;
                margin-bottom: 15px;
                text-align: center;
                padding: 12px;
            }

            /* Quebra as linhas: campos ficam um embaixo do outro */
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            .form-group {
                margin-bottom: 15px;
            }

            h2 { font-size: 22px; }
            
            input, select, button {
                font-size: 16px; /* Evita zoom autom√°tico no iPhone */
            }
        }
    </style>
</head>
<body>

<div class="container">
    
    <button class="btn-admin" onclick="acessarAdmin()">üëÆ‚Äç‚ôÇÔ∏è √Årea do Comandante</button>

    <div id="formArea">
        <h2>üöî S.G.P - Patrulha RAIO</h2>
        <form id="registroForm">
            
            <div class="form-row">
                <div class="form-group">
                    <label for="tipo">Tipo de Registro:</label>
                    <select id="tipo" required>
                        <option value="SAIDA">SA√çDA (In√≠cio de Turno)</option>
                        <option value="ENTRADA">ENTRADA (Fim de Turno)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="timestamp">Data/Hora:</label>
                    <input type="datetime-local" id="timestamp" required>
                </div>
            </div>
    
            <div class="form-group" style="margin-bottom: 15px;">
                <label for="grad_nome">Gradua√ß√£o e Nome de Guerra:</label>
                <input type="text" id="grad_nome" placeholder="Ex: SD SERPA" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="equipe">Equipe / Prefixo:</label>
                    <input type="text" id="equipe" placeholder="Ex: RAIO 01" list="listaEquipes" required>
                    <datalist id="listaEquipes">
                        <option value="RAIO 01"><option value="RAIO 02"><option value="RAIO 03">
                        <option value="VTR COMANDO"><option value="VTR APOIO">
                    </datalist>
                </div>
                <div class="form-group">
                    <label for="funcao">Fun√ß√£o:</label>
                    <select id="funcao" required>
                        <option value="" disabled selected>Selecione...</option>
                        <option value="COMANDANTE">Comandante de Equipe</option>
                        <option value="SUBCOMANDANTE">Subcomandante / Piloto</option>
                        <option value="3¬∫ HOMEM">3¬∫ Homem / Garupa</option>
                        <option value="4¬∫ HOMEM">4¬∫ Homem</option>
                        <option value="MOTORISTA">Motorista Viatura</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="area">√Årea de Atua√ß√£o:</label>
                    <input type="text" id="area" placeholder="Ex: Centro" required>
                </div>
                <div class="form-group">
                    <label for="ht">N√∫mero do HT (R√°dio):</label>
                    <input type="number" inputmode="numeric" id="ht" placeholder="Ex: 123456" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="vtr_armamento">ID Viatura/Arma:</label>
                    <input type="text" id="vtr_armamento" placeholder="Ex: VTR 101 ou PT 40" required>
                </div>
                <div class="form-group">
                    <label for="km_registro">KM Atual (VTR):</label>
                    <input type="number" inputmode="numeric" id="km_registro" placeholder="0 se for arma" value="0">
                </div>
            </div>
    
            <label style="margin-top: 10px;">Confirma√ß√£o Visual (Obrigat√≥rio):</label>
            <div class="camera-box">
                <span id="cameraPlaceholder" class="placeholder-text">C√¢mera desligada</span>
                <video id="video" autoplay playsinline></video>
                <img id="fotoPreview" class="preview-img" alt="Foto capturada">
                <canvas id="canvas"></canvas>
                
                <button type="button" id="btnCapturar" class="btn-foto">üì∏ Ativar C√¢mera</button>
                <button type="button" id="btnDesativar" class="btn-desativar">‚ùå Desativar</button>
            </div>
            <input type="hidden" id="foto_base64" required>
    
            <button type="submit" class="btn-enviar">‚úÖ REGISTRAR SERVI√áO</button>
        </form>
        <div id="statusMessage" class="message"></div>
    </div>

    <div id="receiptArea">
        <h2 style="color: #28a745; text-align: center;">‚úÖ Registro Realizado!</h2>
        <div style="text-align: center;">
            <img id="rec_foto" style="width: 150px; border-radius: 10px; border: 3px solid #28a745;" src="">
        </div>
        <div id="rec_detalhes" style="margin-top: 20px;"></div>
        <button onclick="voltarInicio()" class="btn-novo">üîÑ Novo Registro</button>
    </div>

    <div id="adminArea">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 style="margin: 0; font-size: 20px;">üëÆ‚Äç‚ôÇÔ∏è Painel Comandante</h2>
            <button onclick="fecharAdmin()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold;">Sair</button>
        </div>
        <p style="font-size: 14px; color: #666;">Hist√≥rico local deste dispositivo.</p>
        
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Foto</th><th>Data</th><th>Tipo</th><th>Policial</th><th>Equipe</th><th>Fun√ß√£o</th><th>HT</th><th>Item</th><th>KM</th><th>√Årea</th>
                    </tr>
                </thead>
                <tbody id="tabelaAdmin"></tbody>
            </table>
        </div>
        <button onclick="limparBancoDados()" style="margin-top: 20px; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 8px; width: 100%;">üóëÔ∏è Limpar Hist√≥rico Local</button>
    </div>

</div>

<script>
    // --- COLE SEU LINK DE PRODU√á√ÉO AQUI EMBAIXO ---
    const N8N_WEBHOOK_URL = 'http://167.71.175.51.nip.io:5678/webhook/78e44c0c-4705-45b4-b0bd-106849701da5'; 
    const SENHA_ADMIN = "raio190"; 

    // Refer√™ncias
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const fotoPreview = document.getElementById('fotoPreview');
    const btnCapturar = document.getElementById('btnCapturar');
    const btnDesativar = document.getElementById('btnDesativar');
    const cameraPlaceholder = document.getElementById('cameraPlaceholder');
    const campoFoto = document.getElementById('foto_base64');
    
    const formArea = document.getElementById('formArea');
    const receiptArea = document.getElementById('receiptArea');
    const adminArea = document.getElementById('adminArea');
    const tabelaAdmin = document.getElementById('tabelaAdmin');
    
    let streamCamera = null;
    let cameraLigada = false;

    // --- C√ÇMERA ---
    btnCapturar.addEventListener('click', () => {
        if (!cameraLigada) iniciarCamera();
        else tirarFoto();
    });

    btnDesativar.addEventListener('click', pararCameraVisual);

    function iniciarCamera() {
        btnCapturar.innerText = '‚è≥ Ligando...';
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
        .then(stream => { 
            streamCamera = stream;
            video.srcObject = stream; 
            video.onloadedmetadata = () => { video.play(); };
            video.style.display = 'block';
            cameraPlaceholder.style.display = 'none';
            fotoPreview.style.display = 'none';
            btnCapturar.innerText = 'üîò CAPTURAR';
            btnCapturar.classList.remove('btn-foto');
            btnCapturar.classList.add('btn-capturar');
            btnDesativar.style.display = 'block';
            cameraLigada = true;
        })
        .catch(err => {
            console.error(err);
            alert("Erro ao abrir c√¢mera. Em celulares, verifique se o site tem HTTPS (Cadeado).");
            btnCapturar.innerText = 'üì∏ Ativar C√¢mera';
        });
    }

    function tirarFoto() {
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const dataURL = canvas.toDataURL('image/jpeg', 0.7); // Qualidade 0.7 para ficar mais leve no 4G
        campoFoto.value = dataURL;
        pararCamera();
        fotoPreview.src = dataURL;
        fotoPreview.style.display = 'block';
        video.style.display = 'none';
        cameraPlaceholder.style.display = 'none';
        btnCapturar.innerText = 'üîÑ Refazer Foto';
        btnCapturar.classList.add('btn-foto');
        btnCapturar.classList.remove('btn-capturar');
        btnDesativar.style.display = 'none';
        cameraLigada = false;
    }

    function pararCamera() {
        if (streamCamera) {
            streamCamera.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
    }

    function pararCameraVisual() {
        pararCamera();
        video.style.display = 'none';
        cameraPlaceholder.style.display = 'inline';
        fotoPreview.style.display = 'none';
        btnCapturar.innerText = 'üì∏ Ativar C√¢mera';
        btnCapturar.classList.add('btn-foto');
        btnCapturar.classList.remove('btn-capturar');
        btnDesativar.style.display = 'none';
        campoFoto.value = '';
        cameraLigada = false;
    }

    // --- DATA ---
    document.addEventListener('DOMContentLoaded', () => {
        const now = new Date();
        const localNow = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
        document.getElementById('timestamp').value = localNow;
    });

    // --- ENVIO (COM CORRE√á√ÉO NO-CORS) ---
    document.getElementById('registroForm').addEventListener('submit', function(e) {
        e.preventDefault();
        if (!campoFoto.value) return alert("‚ö†Ô∏è A foto √© obrigat√≥ria!");

        const statusMessage = document.getElementById('statusMessage');
        statusMessage.innerText = 'Enviando...';
        statusMessage.style.color = '#333';

        const dados = {
            tipo: document.getElementById('tipo').value,
            nome: document.getElementById('grad_nome').value.toUpperCase(),
            equipe: document.getElementById('equipe').value.toUpperCase(),
            funcao: document.getElementById('funcao').value,
            area: document.getElementById('area').value.toUpperCase(),
            ht: document.getElementById('ht').value,
            item: document.getElementById('vtr_armamento').value.toUpperCase(),
            km: document.getElementById('km_registro').value,
            data: document.getElementById('timestamp').value.replace('T', ' '),
            foto: campoFoto.value
        };

        const formData = new URLSearchParams();
        for (const key in dados) formData.append(key, dados[key]);

        fetch(N8N_WEBHOOK_URL, {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData
        })
        .then(() => {
            statusMessage.innerText = '';
            pararCameraVisual();
            salvarLocal(dados);

            document.getElementById('rec_foto').src = dados.foto;
            document.getElementById('rec_detalhes').innerHTML = `
                <div class="receipt-item"><span class="receipt-label">Policial:</span><span>${dados.nome}</span></div>
                <div class="receipt-item"><span class="receipt-label">Equipe:</span><span>${dados.equipe}</span></div>
                <div class="receipt-item"><span class="receipt-label">Item:</span><span>${dados.item}</span></div>
            `;
            
            formArea.style.display = 'none';
            receiptArea.style.display = 'block';
            window.scrollTo(0, 0);
            document.getElementById('registroForm').reset();
            
            // Atualiza data novamente ap√≥s reset
            const now = new Date();
            const localNow = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('timestamp').value = localNow;
        })
        .catch(err => {
            console.error(err);
            statusMessage.style.color = 'red';
            statusMessage.innerText = '‚ùå Erro de conex√£o. Verifique se o n8n est√° ativo.';
        });
    });

    function voltarInicio() {
        receiptArea.style.display = 'none';
        adminArea.style.display = 'none';
        formArea.style.display = 'block';
        window.scrollTo(0, 0);
    }

    // --- ADMINISTRA√á√ÉO ---
    function salvarLocal(dados) {
        let db = JSON.parse(localStorage.getItem('sgp_raio_db') || '[]');
        db.unshift(dados);
        localStorage.setItem('sgp_raio_db', JSON.stringify(db));
    }

    function acessarAdmin() {
        const senha = prompt("üîí Digite a Senha do Comandante:");
        if (senha === SENHA_ADMIN) {
            carregarTabelaAdmin();
            formArea.style.display = 'none';
            receiptArea.style.display = 'none';
            adminArea.style.display = 'block';
            window.scrollTo(0, 0);
        } else {
            alert("Senha incorreta!");
        }
    }

    function fecharAdmin() {
        adminArea.style.display = 'none';
        formArea.style.display = 'block';
        window.scrollTo(0, 0);
    }

    function carregarTabelaAdmin() {
        const db = JSON.parse(localStorage.getItem('sgp_raio_db') || '[]');
        tabelaAdmin.innerHTML = '';
        if (db.length === 0) {
            tabelaAdmin.innerHTML = '<tr><td colspan="10" style="text-align:center">Nenhum registro.</td></tr>';
            return;
        }
        db.forEach(reg => {
            tabelaAdmin.innerHTML += `
                <tr>
                    <td><img src="${reg.foto}" onclick="window.open('${reg.foto}')"></td>
                    <td>${reg.data}</td>
                    <td>${reg.tipo}</td>
                    <td>${reg.nome}</td>
                    <td>${reg.equipe}</td>
                    <td>${reg.funcao}</td>
                    <td>${reg.ht}</td>
                    <td>${reg.item}</td>
                    <td>${reg.km}</td>
                    <td>${reg.area}</td>
                </tr>`;
        });
    }

    function limparBancoDados() {
        if(confirm("Apagar todo o hist√≥rico local?")) {
            localStorage.removeItem('sgp_raio_db');
            carregarTabelaAdmin();
        }
    }
</script>

</body>
</html>
